## 类加载机制

### 1. 概念

​		Java虚拟机把描述类的数据从Class文件加载到内存，并对数据进行校验、转换解析和初始化，最终形成可以被虚拟机直接使用的Java类型，这个过程被称作虚拟机的类加载机制。与那些在编译时需要进行连接的语言不同，在Java语言里面，类型的加载、连接和初始化过程都是在程序运行期间完成的，这种策略让Java语言进行提前编译会面临额外的困难，也会让类加载时稍微增加一些性能开销，但是却为Java应用提供了极高的扩展性和灵活性，Java天生可以动态扩展的语言特性就是依赖运行期动态加载和动态连接这个特点实现的。

### 2. 类加载过程

​		一个类型从被加载到虚拟机内存中开始，到卸载出内存为止，它的整个生命周期将会经历加载（Loading）、验证（Verification）、准备（Preparation）、解析（Resolution）、初始化（Initialization）、使用（Using）和卸载（Unloading）七个阶段，其中验证、准备、解析三个部分统称为连接（Linking）。如图所示：

![image-20200822115432440](https://pictures.huazai.fun/uPic/image-20200822115432440.png)

图7-1中，加载、验证、准备、初始化和卸载这五个阶段的顺序是确定的，类型的加载过程必须按照这种顺序按部就班地开始，而解析阶段则不一定：它在某些情况下可以在初始化阶段之后再开始，这是为了支持Java语言的运行时绑定特性（也称为动态绑定或晚期绑定）。请注意，这里写的是按部就班地“开始”，而不是按部就班地“进行”或按部就班地“完成”，强调这点是因为这些阶段通常都是互相交叉地混合进行的，会在一个阶段执行的过程中调用、激活另一个阶段。

+ 加载

  ​	加载时类加载过程的第一个阶段，在加载阶段，JVM需要完成三件事情：

  1. 过一个类的全限定名来获取定义此类的二进制字节流
  2. 将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构
  3. 在内存中生成一个代表这个类的java.lang.Class对象，作为方法区这个类的各种数据的访问入口

+ 验证

  ​	验证阶段的主要目的是为了确验证Class文件的字节流中包含的信息符合当前虚拟机的规范，确保不会危害虚拟机的安全

+ 准备

  ​	准备阶段是正式为类变量（静态变量）分配内存并设置初始值的阶段，即在方法区（Java8后HotSpot虚拟机在堆中）中分配这些变量使用的内存空间。注意这里的设置初始值是设置默认值，不是实际值，比如int 的默认值为0，boolean的默认值为false。如果有final字段会直接设置实际值。

+ 解析

  ​	解析阶段是指虚拟机将常量池中的符号引用替换为直接引用的过程

  + 符号引用：符号引用是一串“字符串”。能够定位到指定的数据。符号引用与虚拟机实现的布局无关，引用目标不一定要已经加载到内存中。
  + 直接引用：直接引用可以是指向目标的指针，相对偏移量或是一个能间接定位到目标的句柄，直接引用的目标必定在内存中存在。

+ 初始化

  ​	初始化是类加载的最后一个步骤，在前面的阶段中除了在加载阶段可以自定义类加载器外，其它操作都完全由JVM来控制，到了初始化阶段，才开始执行类中定义的Java程序代码。



### 3. 类加载器